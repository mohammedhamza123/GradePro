# دليل نظام إدارة التوكن - Gradify

## نظرة عامة

تم تحسين نظام إدارة التوكن في تطبيق Gradify ليوفر تجربة مستخدم أفضل مع تسجيل دخول تلقائي وحفظ آمن للجلسة.

## الميزات الجديدة

### ✅ تسجيل دخول تلقائي
- حفظ التوكن تلقائياً عند تسجيل الدخول
- إعادة تسجيل الدخول تلقائياً عند فتح التطبيق
- لا حاجة لإعادة إدخال اسم المستخدم وكلمة المرور

### ✅ إدارة آمنة للتوكن
- حفظ التوكن في SharedPreferences بشكل آمن
- تحديث تلقائي للتوكن عند انتهاء صلاحيته
- مسح كامل للبيانات عند تسجيل الخروج

### ✅ تجربة مستخدم محسنة
- تحميل سريع للبيانات
- رسائل خطأ واضحة باللغة العربية
- معالجة أفضل للأخطاء

## الملفات المحدثة

### 1. `lib/services/token_manager.dart` (جديد)
```dart
// إدارة مركزية للتوكن
class TokenManager {
  // حفظ التوكن
  static Future<void> saveTokens({...})
  
  // الحصول على التوكن
  static Future<String?> getAccessToken()
  static Future<String?> getRefreshToken()
  
  // مسح التوكن
  static Future<void> clearAllTokens()
}
```

### 2. `lib/services/login_services.dart`
```dart
// تحسينات في:
- دالة login(): حفظ التوكن باستخدام TokenManager
- دالة refreshLoginService(): تحديث التوكن تلقائياً
- دالة logout(): مسح كامل للبيانات
```

### 3. `lib/services/internet_services.dart`
```dart
// تحسينات في:
- تحميل التوكن تلقائياً عند بدء التطبيق
- استخدام TokenManager لإدارة التوكن
```

### 4. `lib/providers/user_provider.dart`
```dart
// تحسينات في:
- دالة refreshLogin: تحقق محسن من حالة تسجيل الدخول
- دالة loginUser: حفظ البيانات باستخدام TokenManager
- دالة logout: مسح كامل للبيانات
```

### 5. `lib/pages/login_page.dart`
```dart
// تحسينات في:
- دالة _checkLoginStatus: تحقق محسن من حالة تسجيل الدخول
- تحميل التوكن قبل التحقق من الحالة
```

### 6. `lib/pages/settings_page.dart`
```dart
// تحسينات في:
- زر تسجيل الخروج: استخدام دالة logout المحسنة
```

### 7. `lib/main.dart`
```dart
// تحسينات في:
- HomePage: معالجة أفضل لحالات تسجيل الدخول
- رسائل debug محسنة
```

## كيفية العمل

### عند تسجيل الدخول:
1. المستخدم يدخل اسم المستخدم وكلمة المرور
2. يتم إرسال البيانات للخادم
3. عند النجاح، يتم حفظ:
   - Access Token
   - Refresh Token
   - اسم المستخدم
4. يتم توجيه المستخدم للصفحة المناسبة

### عند فتح التطبيق:
1. يتم تحميل التوكن من SharedPreferences
2. التحقق من صلاحية التوكن
3. إذا كان صالحاً: توجيه مباشر للصفحة المناسبة
4. إذا انتهت صلاحيته: محاولة تحديثه
5. إذا فشل التحديث: عرض صفحة تسجيل الدخول

### عند تسجيل الخروج:
1. مسح التوكن من الذاكرة
2. مسح جميع البيانات المحفوظة
3. توجيه المستخدم لصفحة البداية

## رسائل Debug

النظام يحتوي على رسائل debug مفصلة لتتبع العملية:

```
DEBUG: Starting login process...
DEBUG: Login successful, tokens saved
DEBUG: User logged in - ID: 123, Group: 2, Username: student123
DEBUG: Token refreshed successfully
DEBUG: User logged out successfully
```

## معالجة الأخطاء

### أخطاء الشبكة:
- رسائل خطأ واضحة باللغة العربية
- إعادة المحاولة التلقائية
- معالجة انقطاع الاتصال

### أخطاء التوكن:
- تحديث تلقائي للتوكن
- مسح البيانات عند فشل التحديث
- توجيه المستخدم لتسجيل الدخول مرة أخرى

## الأمان

### حفظ آمن:
- استخدام SharedPreferences للتخزين المحلي
- عدم حفظ كلمات المرور
- مسح كامل للبيانات عند تسجيل الخروج

### حماية البيانات:
- التحقق من صلاحية التوكن قبل كل طلب
- معالجة آمنة للأخطاء
- عدم تسريب المعلومات الحساسة

## الاختبار

### سيناريوهات الاختبار:
1. ✅ تسجيل دخول جديد
2. ✅ إعادة فتح التطبيق (تسجيل دخول تلقائي)
3. ✅ تحديث التوكن تلقائياً
4. ✅ تسجيل الخروج
5. ✅ معالجة أخطاء الشبكة
6. ✅ معالجة انتهاء صلاحية التوكن

## الاستخدام

### للمطورين:
```dart
// حفظ التوكن
await TokenManager.saveTokens(
  accessToken: "access_token_here",
  refreshToken: "refresh_token_here",
  username: "username_here",
);

// التحقق من وجود توكن
bool hasToken = await TokenManager.hasValidToken();

// مسح جميع البيانات
await TokenManager.clearAllTokens();
```

### للمستخدمين:
- لا حاجة لإجراء أي إعدادات إضافية
- النظام يعمل تلقائياً
- تجربة مستخدم سلسة ومحسنة

## الدعم

في حالة وجود أي مشاكل:
1. تحقق من رسائل Debug في Console
2. تأكد من اتصال الإنترنت
3. جرب تسجيل الخروج وإعادة تسجيل الدخول
4. إذا استمرت المشكلة، امسح بيانات التطبيق

---

**تم تطوير هذا النظام لتحسين تجربة المستخدم وجعل عملية تسجيل الدخول أكثر سلاسة وأماناً.** 